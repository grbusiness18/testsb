'use strict';

const _ = require('lodash');
const configUtil = require('../utils/config-util');

module.exports = function addBrokerContext(req, res, next) {
  const SBF_SUFFIX = req.catalogSuffix;

  req.brokerContext = _.merge(req.params, req.body, req.query);
  if (SBF_SUFFIX && req.brokerContext.service_id && typeof req.brokerContext.service_id === 'string') {
    req.brokerContext.service_id = configUtil.stripSuffix(req.brokerContext.service_id, SBF_SUFFIX); // eslint-disable-line camelcase
  }
  if (SBF_SUFFIX && req.brokerContext.plan_id && typeof req.brokerContext.plan_id === 'string') {
    req.brokerContext.plan_id = configUtil.stripSuffix(req.brokerContext.plan_id, SBF_SUFFIX); // eslint-disable-line camelcase
  }
  if (req.originatingIdentity) {
    req.brokerContext.originating_identity = req.originatingIdentity; // eslint-disable-line camelcase
  }
  req.brokerContext.user_id = req.brokerUser; // eslint-disable-line camelcase

  next();
};
